name: Auto Merge dev1 to dev

on:
  schedule:
    # æœˆæ›œæ—¥ã‹ã‚‰é‡‘æ›œæ—¥ã®13:00 JST (04:00 UTC)
    - cron: '0 4 * * 1-5'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Send Slack notification - Start
      run: |
        curl -X POST -H 'Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}' \
        -H 'Content-type: application/json' \
        --data '{
          "channel": "#general",
          "text": "ğŸš€ è‡ªå‹•ãƒãƒ¼ã‚¸ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™",
          "attachments": [
            {
              "color": "#36a64f",
              "fields": [
                {
                  "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "dev1 â†’ dev",
                  "short": true
                },
                {
                  "title": "é–‹å§‹æ™‚åˆ»",
                  "value": "'$(date +"%Y-%m-%d %H:%M:%S")'",
                  "short": true
                },
                {
                  "title": "ãƒªãƒã‚¸ãƒˆãƒª",
                  "value": "${{ github.repository }}",
                  "short": true
                }
              ]
            }
          ]
        }' \
        https://slack.com/api/chat.postMessage

    - name: Fetch latest changes
      run: |
        git fetch origin dev1
        git fetch origin dev

    - name: Check if dev1 has new commits
      id: check_commits
      run: |
        git checkout dev
        BEHIND_COUNT=$(git rev-list --count dev..origin/dev1)
        echo "behind_count=$BEHIND_COUNT" >> $GITHUB_OUTPUT
        echo "dev1ãƒ–ãƒ©ãƒ³ãƒã¯${BEHIND_COUNT}ã‚³ãƒŸãƒƒãƒˆå…ˆè¡Œã—ã¦ã„ã¾ã™"

    - name: Get latest commit info from dev1
      if: steps.check_commits.outputs.behind_count > 0
      id: commit_info
      run: |
        LATEST_COMMIT=$(git log origin/dev1 --oneline -1)
        echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT

    - name: Merge dev1 to dev
      if: steps.check_commits.outputs.behind_count > 0
      run: |
        git checkout dev
        git merge origin/dev1 --no-ff -m "Auto merge: dev1 to dev [$(date +'%Y-%m-%d %H:%M:%S')]"
        git push origin dev

    - name: Send Slack notification - Success
      if: success() && steps.check_commits.outputs.behind_count > 0
      run: |
        curl -X POST -H 'Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}' \
        -H 'Content-type: application/json' \
        --data '{
          "channel": "#general",
          "text": "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ",
          "attachments": [
            {
              "color": "#36a64f",
              "fields": [
                {
                  "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "dev1 â†’ dev",
                  "short": true
                },
                {
                  "title": "ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆæ•°",
                  "value": "${{ steps.check_commits.outputs.behind_count }}",
                  "short": true
                },
                {
                  "title": "æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ",
                  "value": "${{ steps.commit_info.outputs.latest_commit }}",
                  "short": false
                },
                {
                  "title": "ãƒªãƒã‚¸ãƒˆãƒª",
                  "value": "${{ github.repository }}",
                  "short": false
                }
              ]
            }
          ]
        }' \
        https://slack.com/api/chat.postMessage

    - name: Send Slack notification - No changes
      if: success() && steps.check_commits.outputs.behind_count == 0
      run: |
        curl -X POST -H 'Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}' \
        -H 'Content-type: application/json' \
        --data '{
          "channel": "#general",
          "text": "â„¹ï¸ ãƒãƒ¼ã‚¸ã™ã‚‹æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ",
          "attachments": [
            {
              "color": "#ffcc00",
              "fields": [
                {
                  "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "dev1 â†’ dev",
                  "short": true
                },
                {
                  "title": "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
                  "value": "å¤‰æ›´ãªã—",
                  "short": true
                },
                {
                  "title": "ç¢ºèªæ™‚åˆ»",
                  "value": "'$(date +"%Y-%m-%d %H:%M:%S")'",
                  "short": true
                }
              ]
            }
          ]
        }' \
        https://slack.com/api/chat.postMessage

    - name: Send Slack notification - Failure
      if: failure()
      run: |
        curl -X POST -H 'Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}' \
        -H 'Content-type: application/json' \
        --data '{
          "channel": "#general",
          "text": "âŒ è‡ªå‹•ãƒãƒ¼ã‚¸ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
          "attachments": [
            {
              "color": "#ff0000",
              "fields": [
                {
                  "title": "ãƒ–ãƒ©ãƒ³ãƒ",
                  "value": "dev1 â†’ dev",
                  "short": true
                },
                {
                  "title": "ã‚¨ãƒ©ãƒ¼æ™‚åˆ»",
                  "value": "'$(date +"%Y-%m-%d %H:%M:%S")'",
                  "short": true
                },
                {
                  "title": "ã‚¨ãƒ©ãƒ¼å†…å®¹",
                  "value": "ãƒãƒ¼ã‚¸ãƒ—ãƒ­ã‚»ã‚¹ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã¾ãŸã¯æ¨©é™ã®å•é¡ŒãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚",
                  "short": false
                },
                {
                  "title": "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è©³ç´°",
                  "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "short": false
                }
              ]
            }
          ]
        }' \
        https://slack.com/api/chat.postMessage